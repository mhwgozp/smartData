#!/usr/bin/python
# -*- coding: UTF-8 -*-

import tushare as ts
import pandas as pd
import numpy as np
import os
import Mylog
import Math
import time

class PE:

    def __init__(self):
        print(1)

    def calPE(self):
        print(1)

    def calPEttm(self):
        print(2)

    def getEPSttm(self, df):
        print(3)

if __name__ == "__main__":
    ts.set_token('abc23dc1908af03d82e14f830e52e28300ef5ac69bb5fe14e2ba8630')
    pro = ts.pro_api()
    df1 = pro.query('fina_indicator', ts_code='600000.SH', start_date='19910101', end_date='20100101')
    df2 = pro.query('fina_indicator', ts_code='600000.SH', start_date='20100101', end_date='20200427')
    df3 = df2.append(df1, ignore_index=True)
    df_fina = pd.DataFrame(df3, columns=['ts_code', 'ann_date', 'end_date', 'eps', 'dt_eps', 'total_revenue_ps', 'dt_eps_qua', 'dt_eps_ttm'])

    df_fina['dt_eps_qua'] = df_fina['dt_eps'].diff(periods=-1)
    for index, row in df_fina.iterrows():
        if row['end_date'][4:8] == '0331':
            df_fina.loc[index,'dt_eps_qua'] = row['dt_eps']

    for index, row in df_fina.iterrows():
        if index+4 <= len(df_fina):
            df_fina.loc[index,'dt_eps_ttm']  = df_fina.loc[index,'dt_eps_qua'] + df_fina.loc[index+1,'dt_eps_qua'] + df_fina.loc[index+2,'dt_eps_qua'] + df_fina.loc[index+3,'dt_eps_qua']

    df_daliy = pro.daily(ts_code='600000.SH', start_date='20180101', end_date='20200427')

    for index, row in df_daliy.iterrows():
        trade_date = time.strptime(row['trade_date'], "%Y%m%d")
        for index2, row2 in df_fina.iterrows():
            fina_date = time.strptime(row2['ann_date'], "%Y%m%d")
            if trade_date >= fina_date:
                df_daliy.loc[index, 'pe_ttm'] = Math.div(row['close'], row2['dt_eps_ttm'])
                break

    print(df_daliy)






